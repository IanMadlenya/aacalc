{% extends "base.html" %}

{% comment %}

AACalc - Asset Allocation Calculator
Copyright (C) 2009, 2011-2015 Gordon Irlam

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

{% endcomment %}

{% block title %}Asset allocation calculator{% endblock %}

{% block head %}
<meta name="description" content="Compute appropriate asset and income annuity allocations using scientific principles. And explain how the recommendations were derived." /><!-- Keep content to less than 155 characters according to Wikipedia. -->
<script type="text/javascript" src="/static/js/jquery-1.10.2.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    // Handle page reloads, button state may be remembered by browser but show/hide are not.
    $('.advanced_button:checked').closest('.simple_advanced').find('.advanced,.simple').toggle();
    $('.advanced_button').click(function() {
        $(this).closest('.simple_advanced').find('.advanced,.simple').toggle();
    });

    e = document.getElementById("results");
    if (e)
         e.scrollIntoView();
});
</script>
{% endblock %}

{% block content %}

<h1>Asset allocation calculator</h1>

<p>
<img style="float: right; margin-left: 10px;" width=400 height=200 src="/static/images/iStock_000019076339XSmall.jpg" alt="financial planning">
</p>

<p>
This calculator computes asset and income annuity allocations using
scientific principles. And it explains how the recommendations were
derived.
</p>

<form  method="post">
{% csrf_token %}

{% if errors_present %}
<div class="errorlist">
Please correct the errors in red below:
</div>
{{ alloc_form.non_field_errors }}
{% endif %}

<h2>Longevity</h2>

<div class="indent">

Sex: {{ alloc_form.sex }}
Age: {{ alloc_form.age }}
{{ alloc_form.sex.errors }}
{{ alloc_form.age.errors }}
<br />
Spouse/partner: {{ alloc_form.sex2 }}
Age: {{ alloc_form.age2 }}
{{ alloc_form.sex2.errors }}
{{ alloc_form.age2.errors }}
<br />
<br />
Calculation date: {{ alloc_form.date }}
<span class="small">Determines interest rate yield curve.</span>
{{ alloc_form.date.errors }}
</div>

<h2>Financial position</h2>

<div class="indent">

{{ alloc_form.db.management_form }}
<table class="table-lined center">
<tr>
<td> </td>
<td> Owner <br /> self/spouse </th>
<td> Starting age </th>
<td> Annual amount </th>
<td> Inflation indexed </th>
<td> Death benefit <br /> Contingent/survivor payout </th>
</tr>
{% for db in alloc_form.db %}
<tr>
<td> {{ db.description }}
<td> {{ db.who }}
<td> {{ db.age }}
<td> {{ db.amount }}
<td> {{ db.inflation_indexed }}
<td> {{ db.joint_type }} {{ db.joint_payout_pct }}%
</tr>
<tr>
<td colspan=6 class="left">
{{ db.description.errors }}
{{ db.who.errors }}
{{ db.age.errors }}
{{ db.amount.errors }}
{{ db.inflation_indexed.errors }}
{{ db.joint_type.errors }}
{{ db.joint_payout_pct.errors }}
</td>
</tr>
{% endfor %}
<tr>
<td colspan=6 class="small left">
Starting age is starting age of the owner.
Contingent: payout reduced on death of either party.
Survivor: payout reduced only on death of the owner.
</td>
</table>
<br />

Pre-tax Traditional IRAs/401(k)s size: {{ alloc_form.p_traditional_iras }}
Tax rate: {{ alloc_form.tax_rate_pct }}%
{{ alloc_form.p_traditional_iras.errors }}
{{ alloc_form.tax_rate_pct.errors }}
<br />
Post-tax Roth IRAs/401(k)s size: {{ alloc_form.p_roth_iras }}
{{ alloc_form.p_roth_iras.errors }}
<br />
Taxable retirement savings size: {{ alloc_form.p }}
{{ alloc_form.p.errors }}
<br />
<br />
Pre-retirement annual contribution amount (irrelevant if retired):
{{ alloc_form.contribution }}
{{ alloc_form.contribution.errors }}
<br />
Growth rate: {{ alloc_form.contribution_growth_pct }}%
Volatility of future payments: {{ alloc_form.contribution_vol_pct }}%
Correlation with equity returns: {{ alloc_form.equity_contribution_corr_pct }}%
{{ alloc_form.contribution_growth_pct.errors }}
{{ alloc_form.contribution_vol_pct.errors }}
{{ alloc_form.equity_contribution_corr_pct.errors }}
<br />
<span class="small">
Contribution are assumed to occur to taxable. Increase contribution amount slightly if to IRAs/401(k)s.
A growth rate of 7% represents a doubling of real
contributions every 10 years.  Remember to take into account life
events such as promotions, paying off a mortgage, or children leaving
home in estimating the contribution growth rate.
</span>

</div>

<h2>Financial goals</h2>

<div class="indent">

Age of primary person at retirement: {{ alloc_form.retirement_age }}
{{ alloc_form.retirement_age.errors }}
<br />
Income required when one party deceased: {{ alloc_form.joint_income_pct }}%
{{ alloc_form.joint_income_pct.errors }}
<br />
Permit recommendation of income annuities: {{ alloc_form.purchase_income_annuity }}
{{ alloc_form.purchase_income_anuity.errors }}

</div>

<h2>Market parameters</h2>

<div class="indent">

Equity expected arithmetic real return, &mu;: {{ alloc_form.equity_ret_pct }}%
Geometric: {{ alloc_form.equity_ret_geom_pct }}%
Volatility: {{ alloc_form.equity_vol_pct }}%
{{ alloc_form.equity_ret_pct.errors }}
{{ alloc_form.equity_ret_geom_pct.errors }}
{{ alloc_form.equity_vol_pct.errors }}
<br />
Standard error of estimate of &mu;: {{ alloc_form.equity_se_pct }}%
{{ alloc_form.equity_se_pct.errors }}
<br />
Also report results {{ alloc_form.equity_range_factor }} standard error above and below &mu;.
{{ alloc_form.equity_range_factor.errors }}
<div class="small">
U.S. market average values for 1927-2014 are 8.7%, 6.8%. 20%, and
2.1%.  Going
forward <a href="http://www.advisorperspectives.com/newsletters12/Jeremy_Siegel_Rob_Arnott_and_Other_Experts_Forecast_Equity_Returns.php">many
experts</a> predict lower stock market returns.  For the normal
distribution, &plusmn;1, &plusmn;2, and &plusmn;3 standard errors
about the mean encompass 68%, 95%, and 99.7% of possible values.
</div>
<br />
Management fees: {{ alloc_form.expense_pct }}%
{{ alloc_form.expense_pct.errors }}

</div>

<h2>Well being</h2>

<div class="indent">

Coefficient of relative risk aversion, &gamma;: {{ alloc_form.gamma }}
{{ alloc_form.gamma.errors }}

</div>

<br />

<div style="text-align:center;">
<input class="button" type="submit" value="Submit" />
</div>

{% if results and not errors_present %}

<br />

<div id="results">
<div class="simple_advanced">

We recommend
{% if results.calc.0.purchase_income_annuity != '0' %}
purchasing an income annuity of {{ results.calc.0.purchase_income_annuity }} and then adopting
{% endif %}
a {{ results.calc.0.aa_equity_pct }}/{{ results.calc.0.aa_bonds_pct }} stock/bond asset allocation.
<div class="small">
This recommendation does not take into account your risk rolerance,
and you might want to adopt a lower asset allocation if you feel you
can not psychologically handle the volatililty associated with the
recommended asset allocation.
</div>

<br />

The proportion of stocks recommended ranged from {{ results.calc.1.aa_equity_pct }}% to {{ results.calc.2.aa_equity_pct }}%.

<br />
<br />

Currently during retirement you should consume about {{ results.consume }} per year.

<br />
<br />

<div class="advanced_controller">
Show calculations: {{ alloc_form.advanced_calculations }}
{{ alloc_form.advanced_calculations.errors }}
</div>

<div class="advanced">

<h3>Common calculations</h3>

Yield curve date: {{ results.yield_curve_date }}.

<br />
<br />

Net present value table:

<table class="table-lined center">
<tr>
<td> </td>
<td> Owner </td>
<td> Net present value
<div class="small">
real interest rate adjusted
</div>
</td>
</tr>
{% for db in results.db %}
<tr>
<td class="left"> {{ db.present.description }} </td>
<td> {{ db.present.who }} </td>
<td class="right"> {{ db.present.nv }} </td>
</tr>
{% endfor %}
<tr>
<td class="left"> Total defined benefits </td>
<th colspan=2 class="right"> {{ results.present.nv_db }} </th>
</tr>
<tr>
<td class="left"> Traditional </td>
<td colspan=2 class="right"> {{ results.present.nv_traditional }} </td>
</tr>
<tr>
<td class="left"> Roth </td>
<td colspan=2 class="right"> {{ results.present.nv_roth }} </td>
</tr>
<tr>
<td class="left"> Taxable </td>
<td colspan=2 class="right"> {{ results.present.nv_taxable }} </td>
</tr>
<tr>
<td class="left"> Total investments </td>
<th colspan=2 class="right"> {{ results.present.nv_investments }} </th>
</tr>
<tr>
<td class="left"> Future contributions </td>
<th colspan=2 class="right"> {{ results.present.nv_contributions }} </th>
</tr>
<tr>
<td class="left"> Total net present value </td>
<th colspan=2 class="right"> {{ results.present.nv }} </th>
</tr>
<tr>
<td class="left"> Future value </td>
<td colspan=2 class="right"> {{ results.future_value }}
<div class="small">
not interest rate adjusted
</div>
</td>
</tr>
<tr>
<td colspan=3 class="left small"> Computed from mortality table and real yield curve. </td>
</tr>
</table>

<br />

Retirement additional life expectancy: {{ results.retirement_life_expectancy }} years
<br />
Recommended annual retirement consumption amount: {{ results.consume }}

<br />
<br />

Liability matching bonds expected arithmetic real return: {{ results.bonds_ret_pct }}%
Macaulay duration: {{ results.bonds_duration }} years
<div class="small">
Computed from mortality table and real yield curve assuming level
income requirements except when one party is deceased.
</div>

{% for calc in results.calc %}

<h3>{{ calc.description }}</h3>

By trial and error we found the future contributions discount rate, d = {{ calc.future_growth_try_pct }}%
Let's see how this works out...

<br />
<br />

Using d as the rate of return for discounted future contributions
gives the following recommended asset allocation:

<table class="table-lined center">
{% for w in calc.w %}
<tr>
<td class="left"> {{ w.name }} </td>
<td class="right"> {{ w.alloc }}% </td>
</tr>
{% endfor %}
<tr>
<td colspan=2 class="small">
Computed assuming liability matching bonds are risk free using the matrix version of <a href="https://en.wikipedia.org/wiki/Merton's_portfolio_problem">Merton's formula</a>.
</td>
</tr>
</table>

<br />

On the other hand, the discounted value of future contributions: {{ calc.discounted_contrib }}

<br />

Discounted future contributions as a proportion of revised total NPV: {{ calc.wc_discounted }}%

<br />
<br />

The percentage holdings of discounted future contributions matching
the recommended percentage is as it should be, since we can neither
buy nor sell them.

<br />
<br />

Adjusting the recommended asset allocation for future contributions
not discounted gives:

<table class="table-lined center">
{% for w in calc.w_prime %}
<tr>
<td class="left"> {{ w.name }} </td>
<td class="right"> {{ w.alloc }}% </td>
</tr>
{% endfor %}
</table>

{% if alloc_form.cleaned_data.purchase_income_annuity %}

<br />

Recommended annuitization ratios for your age: Stocks {{ calc.annuitize_equity_pct }}%. Fixed income {{ calc.annuitize_fixed_pct }}%.
<div class="small">
The advantages of annuitizing the stock portion of a portfolio at
advanced ages are well understood. What isn't well known is that there
are advantages to annuitizing the bond portion of a portfolio at
earlier ages. These ratios are the proportion of each portfolio
holding type that we recommend be annuitized. Two things to beware. In
the US as of 2016 the Money's Worth Ratios for deferred income
annuities were substantially worse than those of single premium
immediate annuities, and it might seem odd to purchase a SPIA
pre-retirement. And these recommendations are for a &gamma; of 4, and
different recommendations would likely apply to a different &gamma;
value.
</div>

{% endif %}

<br />

Adjusting for existing defined benefits and possible income annuity
purchases produces the following recommendations:

<table class="table-lined center">
<tr>
<td class="left"> Stocks </td>
<td class="right"> {{ calc.alloc_equity_pct }}% </td>
</tr>
<tr>
<td class="left"> Future contributions </td>
<td class="right"> {{ calc.alloc_contributions_pct }}% </td>
</tr>
<tr>
<td class="left"> Liability matching bonds </td>
<td class="right"> {{ calc.alloc_bonds_pct }}% </td>
</tr>
<tr>
<td class="left"> Existing defined benefits </td>
<td class="right"> {{ calc.alloc_existing_db_pct }}% </td>
</tr>
<tr>
<td class="left"> New income annuities </td>
<td class="right"> {{ calc.alloc_new_db_pct }}% </td>
</tr>
</table>

{% if alloc_form.cleaned_data.purchase_income_annuity %}

<br />

Recommended income annuity purchase amount: {{ calc.purchase_income_annuity }}

<br />

{% endif %}

<br />

Investment stock/bond asset allocation: {{ calc.aa_equity_pct }}/{{ calc.aa_bonds_pct }}

{% endfor %}

</div>
</div>
</div>

{% endif %}

</form>

{% endblock %}
